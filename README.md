# UDP通信测试项目

这是一个用于Orin机器与TC3开发板之间进行UDP通信的C语言项目，包含性能测试功能。

**注意：所有代码都在Orin机器上运行，TC3开发板运行自己的UDP程序。**

## 功能特性

- ✅ UDP发送模式：向TC3发送UDP报文
- ✅ UDP接收模式：从TC3接收UDP报文
- ✅ 性能测试模式（延迟、吞吐量、丢包率）
- ✅ 多轮迭代测试：支持多轮测试并计算平均值和标准差
- ✅ 交互式通信模式
- ✅ 实时统计信息显示
- ✅ 可配置的端口和IP地址
- ✅ 支持最大UDP数据包测试（默认）

## 项目结构

```
udp_comm/
├── include/
│   └── common.h          # 公共头文件
├── src/
│   ├── common.c          # 公共函数实现
│   ├── server.c          # UDP接收程序（从TC3接收，备用方式）
│   └── client.c          # UDP客户端（支持发送和接收两种模式）
├── Makefile              # 编译脚本
└── README.md            # 说明文档
```

## 编译

```bash
cd udp_comm
make
```

编译后的可执行文件位于 `bin/` 目录：
- `bin/udp_server` - UDP接收程序（用于从TC3接收UDP报文，备用）
- `bin/udp_client` - UDP客户端程序（支持发送和接收两种模式）

**说明：**
- 所有程序都在 **Orin机器** 上运行
- TC3开发板运行自己的UDP程序（不需要运行本项目的代码）
- 推荐使用 `udp_client` 程序，它支持发送和接收两种模式

## 使用方法

所有命令都在 **Orin机器** 上执行。

### 1. 发送模式（向TC3发送UDP报文）

```bash
# 交互式发送模式
./bin/udp_client -i <TC3_IP地址> -p 8888

# 性能测试模式（发送1000个最大UDP包）
./bin/udp_client -i <TC3_IP地址> -p 8888 -t -n 1000 -s 0

# 多轮迭代测试（10轮，每轮1000个包，计算平均值）
./bin/udp_client -i 192.168.1.100 -p 8888 -t -n 1000 -s 0 -r 10

# 自定义包大小和数量
./bin/udp_client -i 192.168.1.100 -p 8888 -t -n 5000 -s 2048
```

### 2. 接收模式（从TC3接收UDP报文）

```bash
# 接收模式：绑定到指定端口，等待接收来自TC3的UDP报文
./bin/udp_client -R -i 0.0.0.0 -p 8888

# 接收模式 + 性能测试模式（统计接收性能）
./bin/udp_client -R -i 0.0.0.0 -p 8888 -t
```

### 3. 使用udp_server接收（备用方式）

如果需要使用server程序接收来自TC3的UDP报文：

```bash
# 接收模式
./bin/udp_server -i 0.0.0.0 -p 8888

# 接收模式 + 性能测试模式
./bin/udp_server -i 0.0.0.0 -p 8888 -t
```

### 4. 命令行参数说明

#### udp_client 参数
- `-h` : 显示帮助信息
- `-p <port>` : 指定服务器端口号（默认: 8888）
- `-i <ip>` : 指定服务器IP地址（发送模式必需）或绑定IP（接收模式）
- `-t` : 启用性能测试模式
- `-R` : 启用接收模式（从TC3接收UDP报文）
- `-n <count>` : 测试数据包数量（默认: 1000）
- `-s <size>` : 数据包大小（字节，0或不设置 = 最大UDP包，默认: 0）
- `-r <iterations>` : 多轮迭代测试次数（默认: 1）

#### udp_server 参数（备用接收程序）
- `-h` : 显示帮助信息
- `-p <port>` : 指定端口号（默认: 8888）
- `-i <ip>` : 指定绑定的IP地址（默认: 0.0.0.0）
- `-t` : 启用性能测试模式

## 性能测试指标

程序会自动统计并显示以下性能指标：

1. **延迟指标**
   - 最小延迟（ms）
   - 最大延迟（ms）
   - 平均延迟（ms）

2. **吞吐量指标**
   - 发送字节数（MB）
   - 接收字节数（MB）
   - 平均吞吐量（Mbps）

3. **可靠性指标**
   - 发送数据包数
   - 接收数据包数
   - 丢失数据包数
   - 丢包率（%）

4. **时间指标**
   - 测试总时长（秒）

## 使用示例

所有示例都在 **Orin机器** 上执行，TC3开发板运行自己的UDP程序。

### 示例1：向TC3发送UDP报文

```bash
# 交互式发送（需要TC3运行接收程序）
./bin/udp_client -i 192.168.1.100 -p 8888

# 性能测试：发送1000个最大UDP包到TC3
./bin/udp_client -i 192.168.1.100 -p 8888 -t -n 1000 -s 0

# 多轮迭代测试：10轮，每轮1000个最大UDP包，计算平均值
./bin/udp_client -i 192.168.1.100 -p 8888 -t -n 1000 -s 0 -r 10
```

### 示例2：从TC3接收UDP报文

```bash
# 接收模式：等待接收来自TC3的UDP报文（需要TC3运行发送程序）
./bin/udp_client -R -i 0.0.0.0 -p 8888 -t
```

### 示例3：本机测试（单机测试）

您可以在Orin本机上进行测试，使用本地回环地址 `127.0.0.1`：

**终端1 - 启动接收端：**
```bash
./bin/udp_client -R -i 127.0.0.1 -p 8888 -t
```

**终端2 - 启动发送端（在同一台机器上）：**
```bash
# 性能测试模式（发送最大UDP包）
./bin/udp_client -i 127.0.0.1 -p 8888 -t -n 1000 -s 0

# 多轮迭代测试
./bin/udp_client -i 127.0.0.1 -p 8888 -t -n 1000 -s 0 -r 10
```

**注意：** 本机测试时不需要配置防火墙，延迟会非常低（通常在 0.1ms 以下），主要用于测试程序功能。

## 注意事项

1. **运行环境**：所有程序都在 **Orin机器** 上运行，TC3开发板运行自己的UDP程序。

2. **IP地址配置**：请根据实际网络环境使用命令行参数指定TC3的IP地址，或修改 `common.h` 中的 `DEFAULT_CLIENT_IP`。

3. **防火墙设置**：在Orin机器上确保防火墙允许UDP端口通信。
   
   **快速配置（推荐）：**
   ```bash
   sudo ./firewall_setup.sh 8888
   ```
   
   详细配置方法请参考 [FIREWALL.md](FIREWALL.md)

4. **网络连接**：确保Orin和TC3在同一局域网内，且网络连接正常。使用 `ping <TC3_IP>` 测试连通性。

5. **数据包大小**：UDP最大数据包大小为65507字节，程序已做限制。使用 `-s 0` 或不设置 `-s` 参数时使用最大UDP包大小。

6. **性能测试**：建议在低负载环境下进行性能测试，以获得准确结果。多轮迭代测试（`-r` 参数）可以获得更稳定的平均值。

## 清理编译文件

```bash
make clean
```

## 安装/卸载

```bash
# 安装到系统路径
make install

# 卸载
make uninstall
```

## 故障排除

1. **连接失败**：
   - 检查TC3的IP地址和端口是否正确，确保TC3端程序已启动
   - 检查Orin机器上的防火墙是否允许UDP端口通信（参考 [FIREWALL.md](FIREWALL.md)）
   - 使用 `ping <TC3_IP>` 测试网络连通性
   - 使用 `netstat -uln | grep 8888` 检查端口是否监听（接收模式下）

2. **丢包率高**：可能是网络拥塞或缓冲区设置过小，尝试调整socket缓冲区大小。使用多轮迭代测试可以获得更准确的平均值。

3. **编译错误**：确保在Orin机器上已安装gcc编译器和必要的开发工具。

4. **防火墙问题**：如果无法通信，请先检查Orin机器上的防火墙配置，参考 [FIREWALL.md](FIREWALL.md)

5. **TC3端问题**：如果发送模式下没有响应，请检查TC3端程序是否正常运行

## 许可证

本项目仅供学习和测试使用。

